function fileName = saveStimulus(fileName, DataBlock, parameterFile, trial, CellNumber, CustomTag)
%function exportFileName = saveStimulus(DataBlock, parameterFile, trial,
%exportPathName, preName)
%
% saves data block and parameters of a single labChart trial (block) to the
% specified path. Note that a labChart block may contain several flyfly
% trials, since the labchart blocks are cut by the (optional) flyfly
% pauses. Which flyfly trials corresponds to this block is specified by the
% parameter "trial", which is in the format [trial1 trial2 ... trialn].
% (Note that trial1 is not equal to 1.)
%
%

load(parameterFile);

%loads:
%-Stimulus
%-debugData
%-message
%-skippedInTrial
%-timeFinish
%-timeStart
%-totalSkippedFrames

Experiment_Name = Stimulus.name;

if isempty(CustomTag)
    clear CustomTag;
end

for n = 1:length(Stimulus.layers)
    
    layer     = debugData.stimulus.layers(n);
    
    for k = 1:length(trial)
        trialData = layer.data(:,trial(k));
        
        layerName = layer.name;
        layerName = regexprep(layerName, ' ', '_'); %replace space with underscore
        
        eval(['Layer_' num2str(n) '_Name = layerName;']);
        
        [R C] = size(trialData);
        for r = 1:R
            
            parName = [layer.parameters{r}];
            parName = regexprep(parName, ' ', '_'); %replace space with underscore

            eval(sprintf('Layer_%d_Parameters.%s(%d)=trialData(%d);',n,parName,k,r));
        end
    end
end

A_spacer = '-------Data and Parameters-----------';
Z_spacer = '-------Additional Stuff -------------';

clear R C parName n layer Stimulus layerName r skippedInTrial ...
    trialData timeFinish exportPathName trial preName k;

save(fileName);



